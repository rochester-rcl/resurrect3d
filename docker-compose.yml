version: "3"

services:
  mongo:
    image: mongo:3.6
    container_name: resurrect-mongo
    volumes:
      - ${MONGO_DATA_DIR}:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: resurrectdb_root
      MONGO_INITDB_ROOT_PASSWORD: resurrectdb

  mongo-test:
    image: mongo:3.6
    container_name: mongo-test
    environment:
      MONGO_INITDB_ROOT_USERNAME: testdb_root
      MONGO_INITDB_ROOT_PASSWORD: test

  server-prod:
    image: resurrect3d/server
    container_name: resurrect-server-prod
    volumes:
      - ${RESURRECT_SERVER_DIR}:/home/node/working
    environment:
      MONGO_URL: "mongodb://resurrectdb_root:resurrectdb@resurrect-mongo:27017/admin"
      NODE_ENV: "production"
    entrypoint: /home/server-entrypoint.sh
    expose:
      - 8000
    ports:
      - 3001:8000
    depends_on:
      - mongo

  server-dev:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: resurrect3d/server
    container_name: resurrect-server-dev
    working_dir: /home/node/working
    volumes:
      - ${RESURRECT_SERVER_DIR}:/home/node/working
    environment:
      MONGO_URL: "mongodb://resurrectdb_root:resurrectdb@resurrect-mongo:27017/admin"
      NODE_ENV: "development"
      TESTING: "false"
    entrypoint: /home/server-entrypoint.sh
    expose:
      - 8000
    ports:
      - 3001:8000
    depends_on:
      - mongo

  server-test:
    image: resurrect3d/server
    container_name: resurrect-server-dev
    working_dir: /home/node/working
    volumes:
      - ${RESURRECT_SERVER_DIR}:/home/node/working
    environment:
      MONGO_TEST_URL: "mongodb://testdb_root:test@mongo-test:27017/admin"
      NODE_ENV: "development"
      TESTING: "true"
      EMAIL_USERNAME: "testuser"
      EMAIL_PASSWORD: "password"
      EMAIL_SERVICE: "fakemail"
      EMAIL_VERIFICATION_ROUTE: "/verify"
    entrypoint: /home/server-entrypoint.sh
    depends_on:
      - mongo-test

  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    image: resurrect3d/client
    container_name: resurrect-client
    working_dir: /home/node/working
    volumes:
      - ${RESURRECT_CLIENT_DIR}:/home/node/working
    environment:
      NODE_ENV: "development"
    entrypoint: /home/client-entrypoint.sh
    depends_on:
      - server-dev
    expose:
      - 3000
    ports:
      - 3000:3000
    stdin_open: true
